<nav class="navbar sticky top-0 z-50 shadow <%= ENV["STAGING_COLOR_MODE"].present? ? ENV["STAGING_COLOR_MODE"] : 'bg-base-100' %>">
  <div class="flex-1">
    <a href="/" aria-label="logo" class="ml-3 mr-6">
      <%= image_tag("1200px-Logo_iae.png", width: 150, alt: 'logo IAE') %>
    </a>
    <ul class="menu menu-horizontal px-1">
      <% if user_signed_in? %>
        <% if current_user.étudiant? %>
          <%= navbar_nav_item('Ma journée', 'today', mes_sessions_etudiant_path, nil, 'mes_sessions_etudiant') %>
          <%= navbar_nav_item('Planning', 'calendar_month', cours_path, 'cours', nil, 'mes_sessions_etudiant') %>
        <% elsif current_user.intervenant? || current_user.enseignant? %>
          <%= navbar_nav_item('Ma journée', 'today', mes_sessions_intervenant_path, nil, 'mes_sessions_intervenant') %>
          <%= navbar_nav_item('Planning', 'calendar_month', cours_path, 'cours', nil, 'mes_sessions_intervenant') %>
        <% else %>
          <%= navbar_nav_item('Planning', 'calendar_month', cours_path, 'cours') %>
        <% end %>
        <% unless current_user.étudiant? %>
          <%= navbar_nav_item('Salles', 'meeting_room', occupation_salles_path, 'salles') %>
        <% end %>
        <% if policy(current_user).left_navbar? %>
          <%= navbar_nav_item('Formations', 'work', formations_path, 'formations', nil, [], "py-0") %>
          <%= navbar_nav_item('Intervenants', 'co_present', intervenants_path, 'intervenants', nil) %>
          <%= navbar_nav_item('Étudiants', 'school', etudiants_path, 'etudiants') %>
        <% end %>
        
        <% if current_user.rh? %>
          <%= navbar_nav_item('Dossiers', 'folder', dossiers_path, 'dossiers') %>
          <%= navbar_nav_item('Vacations', 'co_present', vacations_path, 'vacations') %>
          <%= navbar_nav_item('Responsabilités', 'contract', responsabilites_path, 'responsabilites') %>
        <% end %>

        <% if current_user.intervenant? && !current_user.partenaire_qse? %>
          <%= navbar_nav_item('Sujets d\'examens', 'docs', sujets_intervenant_path(Intervenant.find_by(id: @intervenant_user_id)), 'intervenants', 'sujets') %>
        <% end %>
        <% if current_user.partenaire_qse? %>
          <%= navbar_nav_item('Sujets d\'examens', 'docs', sujets_path(), 'sujets') %>
        <% end %>

        <% if policy(:tool).audit_cours? %>
          <li class="nav-item">
            <% is_active = params[:action] == 'audit_cours' %>
            <%= link_to tools_audit_cours_path, class: "flex items-center gap-1 py-0 text-#{ is_active ? 'primary' : 'base-content' }" do %>
              <span class="material-symbols-outlined text-xl">
                calendar_check
              </span>
              À booker
              <% aplanifier = CoursNonPlanifie.count %>
              <% if aplanifier > 0 %>
                <span class="badge badge-error text-white"><%= aplanifier %></span>
              <% end %>
            <% end %>
          </li>
        <% end %>

        <% if ENV["USER_COMMAND_AUTHORIZATION_IDS"].split(',').map(&:to_i).include?(current_user.id) %>
          <li class="nav-item">
            <% is_active = params[:action] == 'commandes' %>
            <%= link_to tools_commandes_path, class: "flex items-center gap-1 py-0 text-#{ is_active ? 'primary' : 'base-content' }" do %>
              <span class="material-symbols-outlined text-xl">
                local_cafe
              </span>
              Commandes
              <% commandes_count = Cour.joins(:options).where(options: {catégorie: :commande}).where.not("options.description ILIKE ?", '%Fait le%').count %>
              <% if commandes_count > 0 %>
                <span class="badge badge-info text-white"><%= commandes_count %></span>
              <% end %>
            <% end %>
          </li>
        <% end %>

      <% end %>
    </ul>
  </div>

  <div>
    <ul class="menu menu-horizontal items-center px-1">
      <% if user_signed_in? %>
        <li class="flex flex-row items-center gap-2 mr-4">
          <%= link_to current_user do %>
            <span class="material-symbols-outlined p-0">
              <%= current_user.otp_required_for_login? ? 'person_shield' : 'person' %>
            </span>
            <div class="p-0">
              <%= current_user.prénom.humanize %>
              <% if current_page? root_path %>
                <br>
                Dernière connexion il y a <%= time_ago_in_words current_user.last_sign_in_at %>
              <% end %>
            </div>
          <% end %>
        </li>
        <% if policy(Note).index? %>
          <li class="indicator mr-4">
            <%= link_to notes_path, class: "flex items-center gap-1 py-0" do %>
              <span class="material-symbols-outlined text-xl mb-1">
                lightbulb_2
              </span>
              <% notes = current_user.notes.count %>
              <% if notes > 0 %>
                <span class="indicator-item badge badge-warning"><%= notes %></span> 
              <% end %>
            <% end%>
          </li>
        <% end %>
        <% if policy(current_user).right_navbar? %>
          <%= navbar_nav_item('', 'build', tools_index_path) %>
          <%= navbar_nav_item('', 'search', tools_rechercher_path) %>
          <%= navbar_nav_item('', 'info', guide_index_path) %>
        <% end %>

        <li>
          <%= link_to destroy_user_session_path, 'data-turbo-method': :delete, title: "Fermer la session de #{current_user.email}", class: 'flex items-center gap-1 py-0' do %>
            <span class="material-symbols-outlined text-xl mb-0.5">
              logout
            </span>
          <% end %> 
        </li>

      <% else %>
        <%= navbar_nav_item('Se connecter', 'login', new_user_session_path) %>
      <% end %>
    </ul>
  </div>
</nav>