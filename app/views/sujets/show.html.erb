<div class="border-b mt-6 mb-2 pb-4">
  <h1 class="text-3xl flex items-center gap-3">
    <span class="material-symbols-outlined text-3xl">
      docs
    </span>
    Sujet d'examen
  </h1>
</div>


<% if policy(@sujet).valider? %>
  <%= form_with id:'sujet_form', url: deposer_admin_sujet_path, model: @sujet, data: { controller: 'nested-form', nested_form_wrapper_selector_value: '.nested-form-wrapper' } do |f| %>
    <div class="flex flex-wrap justify-between shadow-lg gap-8 p-6 mt-4">
      <div class="flex-1">
        <p class="mb-4">
          <strong>Examen</strong>
          <% if @sujet.cour.debut > DateTime.now %>
            <br>
            <small>(dans <%= time_ago_in_words(@sujet.cour.debut) %>)</small>
            <br>
          <% end %>
          Le <%= l(@sujet.cour.debut, format: :long) %>
        </p>

        <p class="mb-4">
          <strong>Formation(s)</strong>
          <br>
          <%= @sujet.formations.pluck(:nom).join(', ') %>
        </p>

        <p class="mb-4">
          <strong>Nom de l'examen</strong>
          <br>
          <%= @sujet.cour.nom_ou_ue %>
        </p>
        <p class="mb-4">
          <strong>Intervenant</strong>
          <br>
          <%= @sujet.cour.intervenant_binome&.nom_prenom %>
          <br>
          <%= @sujet.cour.intervenant_binome&.email %>
        </p>


        <% if !@sujet.can_déposer? %>
          <p class="mb-4">
            <strong>Options</strong>
            <br>
            Papier : 
            <% if @sujet.papier %>
              <span class='text-success'>Oui</span>
            <% else %>
              <span class='text-error'>Non</span>
            <% end %>
            <br>
            Calculatrice :
            <% if @sujet.calculatrice %>
              <span class='text-success'>Oui</span>
            <% else %>
              <span class='text-error'>Non</span>
            <% end %>
            <br>
            Ordinateur et tablette :
            <% if @sujet.ordi_tablette %>
              <span class='text-success'>Oui</span>
            <% else %>
              <span class='text-error'>Non</span>
            <% end %>
            <br>
            Téléphone :
            <% if @sujet.téléphone %>
              <span class='text-success'>Oui</span>
            <% else %>
              <span class='text-error'>Non</span>
            <% end %>
            <br>
            Dictionnaire :
            <% if @sujet.dictionnaire %>
              <span class='text-success'>Oui</span>
            <% else %>
              <span class='text-error'>Non</span>
            <% end %>
          </p>
        <% else %>
          <div class="mt-8 mb-4">
            <h3 class="text-xl mt-4 font-bold">Sélectionnez les consignes d'examens</h3>
            <i>Cochez les options autorisées</i>
          </div>

          <div class="relative flex-grow max-w-full flex-1 gap-4">
            <%= f.check_box :papier, class: 'hover:cursor-pointer' %>
            <%= f.label :papier, 'Papiers autorisés ?', class: 'hover:cursor-pointer' %>
          </div>

          <div class="relative flex-grow max-w-full flex-1 gap-4">
            <%= f.check_box :calculatrice, class: 'hover:cursor-pointer' %>
            <%= f.label :calculatrice, 'Calculatrice de poche à fonctionnement autonome, sans imprimante et sans aucun moyen de transmission autorisés ?', class: 'hover:cursor-pointer' %>
          </div>
          <div class="relative flex-grow max-w-full flex-1 gap-4">
            <%= f.check_box :ordi_tablette, class: 'hover:cursor-pointer' %>
            <%= f.label :ordi_tablette, 'Ordinateurs et tablettes autorisés ?', class: 'hover:cursor-pointer' %>
          </div>

          <div class="relative flex-grow max-w-full flex-1 gap-4">
            <%= f.check_box :téléphone, class: 'hover:cursor-pointer' %>
            <%= f.label :téléphone, 'Téléphones portables autorisés ?', class: 'hover:cursor-pointer' %>
          </div>

          <div class="relative flex-grow max-w-full flex-1 gap-4">
            <%= f.check_box :dictionnaire, class: 'hover:cursor-pointer' %>
            <%= f.label :dictionnaire, 'Dictionnaires autorisés ?', class: 'hover:cursor-pointer' %>
          </div>
        <% end %>
      </div>

      <div class="flex-1">
        <p class="font-bold mb-2">Document reçu</p>

        <% if @sujet.archivé? %>
          <p class="mb-4">
            Document supprimé
          </p>
        <% else %>
          <% if !@sujet.sujet.attached? %>
            <% if policy(Sujet).index? %>
              <div class="mb-4">
                Aucun sujet pour l'instant.
                <% if @sujet.can_déposer? %>
                  <p class="mt-8 mb-4">Vous pouvez ajouter vous-même le sujet si l'intervenant vous l'a transmi autrement</p>
                  <%= render "partials/script_accept_pdf" %>
                  <%= f.file_field :sujet, required: true, label: 'Fichier PDF', accept: 'application/pdf', class: 'file-input file-input-bordered file-input-sm file-input-success flex-1' %>
                  <br>

                  <div class="mt-8 mb-4">
                    <h3 class="text-xl mt-4">Commentaire (optionnel)</h3>
                    <i>Affiché sur la convocation étudiant</i>
                  </div>

                  <%= f.text_area :commentaires, rows: 3, class: 'textarea textarea-bordered w-full' %>

                  <button type="submit" name="commit" value="Déposer le sujet" class="btn btn-success w-full sm:w-48 btn-lg text-white mt-6" data-disable-with="Déposer le sujet" data-turbo-confirm="ATTENTION ! Une fois déposé, vous ne pourrez plus modifier le sujet. Confirmez-vous le dépôt de votre sujet">
                    <i class="far fa-arrow-alt-circle-down"></i>
                    Déposer
                  </button>
                <% end %>
              </div>
            <% else %>
              <p class="alert mb-4">
                Veuillez ajouter le sujet
              </p>
            <% end %>
          <% else %>
            <% if current_user.otp_required_for_login %>
              <div class="text-center w-fit">
                <% if @sujet.sujet.representable? %>
                  <div class="shadow w-fit p-4 mb-2">
                    <%= link_to image_tag(@sujet.sujet.representation(resize_to_limit: [300, 300])), url_for(@sujet.sujet), title: @sujet.sujet.filename, target: '_blank' %>
                  </div>
                <% end %>
                <%= link_to @sujet.sujet.filename, url_for(@sujet.sujet), target: '_blank', class: 'text-primary hover:underline text-center' %>
              </div>
            <% else %>
              <div class="text-center w-fit">
                <% if @sujet.sujet.representable? %>
                  <div class="shadow w-fit p-4 mb-2">
                    <%= image_tag(@sujet.sujet.representation(resize_to_limit: [300, 300])) %>
                  </div>
                <% end %>
              </div>
              <p class="mb-4">
                <%= link_to "Activer la double authentification", user_path(current_user), class: "text-primary hover:underline font-black" %>
                pour ouvrir le document
              </p>
            <% end %>
          <% end %>
        <% end %>
      </div>

      <div class="flex-1">
        <p class="mb-4">
          <strong>Créé le</strong>
          <br>
          <%= l(@sujet.created_at, format: :long) %>
        </p>
        <p class="mb-4">
          <strong>MÀJ</strong>
          <br>
          <%= l(@sujet.updated_at, format: :long) %>
        </p>

        <p class="mb-4">
          <strong>État :</strong> 
          <span class="badge badge-lg <%= @sujet.style %> text-white">
            <%= @sujet.workflow_state.humanize %>
          </span>
          <% if @sujet.non_conforme? %>
            <br>
            <strong>Raison :</strong> 
            <%= @sujet.message %>
          <% end %>
        </p>

        <% if @sujet.mail_log %>
          <div class="flex flex-wrap gap-4">
            <p class="mb-4">
              <strong>Mail envoyé ? :</strong> 
              <% if @sujet.mail_log.statut %>
                <span class="text-success">OK</span>
              <% else %>
                <span class="text-error">KO</span>
              <% end %>
            </p>
            <p class="mb-4">
              <strong>Ouvert ? :</strong> 
              <% if @sujet.mail_log.opened && @sujet.mail_log.statut %>
                <span class="text-info">OUI</span>
              <% else %>
              <span>NON</span>
              <% end %>
            </p>
          </div>
        <% end %>

        <% if !@sujet.can_déposer? %>
          <p class="mb-4">
            <strong>Commentaires</strong>
            <br>
            <%= @sujet.commentaires %>
          </p>
        <% end %>
      </div>

      
    </div>
  <% end %>

  <div class="flex w-full mt-4">
    <div data-controller="rejet-sujet" class="flex-1">
      <%= link_to_if @sujet.can_valider?, 'Valider', valider_sujet_path(@sujet), class: 'btn btn-sm btn-success text-white', 'data-turbo': false %> |
      <% if @sujet.can_rejeter? %>
        <button id='rejeter-btn' class='btn btn-sm btn-error text-white' data-action="click->rejet-sujet#showForm" data-rejet-sujet-target="btnRejeter">Rejeter</button>
      <% else %>
        Rejeter
      <% end %>
      |
      <%= link_to 'Retour', sujets_path, class: 'text-primary hover:underline' %>

      <%= form_with url: rejeter_sujet_path(@sujet), method: :get do |f| %>
        <div id='rejeter-form' style="display: none;" data-rejet-sujet-target="rejeterForm">
          <div class="flex flex-wrap gap-4 mt-4">
            <%= f.text_field :raisons, class: 'input input-bordered input-sm', placeholder: 'Pour quelle raison ?' %>
            <%= f.submit 'Notifier l\'intervenant', class: 'btn btn-sm btn-error text-white', 'data-rejet-sujet-target': 'btnSubmit' %>
          </div>
        </div>
      <% end %>

    </div>
    <%= link_to "Supprimer le sujet", sujet_path(@sujet), 'data-turbo-method': :delete, 'data-turbo-confirm': 'ATTENTION : Avez-vous bien téléchargé le sujet d\'examen avant de le supprimer ? Il ne sera plus possible de le faire après la suppression !', class: "btn btn-error btn-outline btn-sm" %>
  </div>

  <br>
  <br>
  <h4 class="text-xl mb-4">Audit des modifications</h4>

  <div class="overflow-x-auto">
    <table class="table table-xs">
      <thead class="bg-slate-100 border">
        <th>Date</th>
        <th>Utilisateur</th>            
        <th>Type</th>
        <th>Id</th>
        <th>Action</th>
        <th>Modifications</th>
      </thead>
      <%= render partial: 'tools/audit', collection: @audits %>
    </table>
  </div>
  <div class="page_info">
		<%= page_entries_info @audits, 'Audit' %>
	</div>

	<div class="planning_pagination">
		<%= will_paginate @audits %>
	</div>

<% else %>
  <% if @sujet.can_déposer? %>
    <h2 class="text-lg">
      Merci de <b>déposer votre sujet</b> (avec la page de garde et en y indiquant les consignes) en <b>format PDF</b>.
    </h2>
  <% end %>
  <%= form_with id:'sujet_form', url: deposer_sujet_path, model: @sujet do |f| %>
    <div class="flex flex-wrap shadow-lg gap-8 lg:gap-24 p-6 my-4">
      <div class="flex-1">
        <p class="mb-4">
          <strong>Examen</strong>
          <% if @sujet.cour.debut > DateTime.now %>
            <br>
            <small>(dans <%= time_ago_in_words(@sujet.cour.debut) %>)</small>
            <br>
          <% end %>
          <br>
          Le <%= l(@sujet.cour.debut, format: :long) %>
          <br>
          <%= @sujet.cour.nom_ou_ue %>
        </p>

        <p class="mb-4">
          <strong>Formation(s)</strong>
          <br>
          <%= @sujet.formations.pluck(:nom).join(', ') %>
        </p>

        <% if !@sujet.can_déposer? %>
          <p class="mb-4">
            <strong>État</strong>
            <br>
            <span class="badge badge-lg <%= @sujet.style %> text-white">
              <%= @sujet.workflow_state.humanize %>
            </span>
          </p>

          <p class="mb-4">
            <strong>Options</strong>
            <br>
            Papier : 
            <% if @sujet.papier %>
              <span class='text-success'>Oui</span>
            <% else %>
              <span class='text-error'>Non</span>
            <% end %>
            <br>
            Calculatrice :
            <% if @sujet.calculatrice %>
              <span class='text-success'>Oui</span>
            <% else %>
              <span class='text-error'>Non</span>
            <% end %>
            <br>
            Ordinateur et tablette :
            <% if @sujet.ordi_tablette %>
              <span class='text-success'>Oui</span>
            <% else %>
              <span class='text-error'>Non</span>
            <% end %>
            <br>
            Téléphone :
            <% if @sujet.téléphone %>
              <span class='text-success'>Oui</span>
            <% else %>
              <span class='text-error'>Non</span>
            <% end %>
            <br>
            Dictionnaire :
            <% if @sujet.dictionnaire %>
              <span class='text-success'>Oui</span>
            <% else %>
              <span class='text-error'>Non</span>
            <% end %>
          </p>
        <% else %>
          <div class="mt-8 mb-4">
            <h3 class="text-xl mt-4">Sélectionnez les consignes d'examens</h3>
            <i>Cochez les options autorisées</i>
          </div>

          <div class="relative flex-grow max-w-full flex-1 gap-4">
            <%= f.check_box :papier, class: 'hover:cursor-pointer' %>
            <%= f.label :papier, 'Papiers autorisés ?', class: 'hover:cursor-pointer' %>
          </div>

          <div class="relative flex-grow max-w-full flex-1 gap-4">
            <%= f.check_box :calculatrice, class: 'hover:cursor-pointer' %>
            <%= f.label :calculatrice, 'Calculatrice de poche à fonctionnement autonome, sans imprimante et sans aucun moyen de transmission autorisés ?', class: 'hover:cursor-pointer' %>
          </div>
          <div class="relative flex-grow max-w-full flex-1 gap-4">
            <%= f.check_box :ordi_tablette, class: 'hover:cursor-pointer' %>
            <%= f.label :ordi_tablette, 'Ordinateurs et tablettes autorisés ?', class: 'hover:cursor-pointer' %>
          </div>

          <div class="relative flex-grow max-w-full flex-1 gap-4">
            <%= f.check_box :téléphone, class: 'hover:cursor-pointer' %>
            <%= f.label :téléphone, 'Téléphones portables autorisés ?', class: 'hover:cursor-pointer' %>
          </div>

          <div class="relative flex-grow max-w-full flex-1 gap-4">
            <%= f.check_box :dictionnaire, class: 'hover:cursor-pointer' %>
            <%= f.label :dictionnaire, 'Dictionnaires autorisés ?', class: 'hover:cursor-pointer' %>
          </div>
        <% end %>
      </div>

      <div class="flex-1">

        <% if !@sujet.sujet.attached? %>
          <% if policy(Sujet).index? %>
            <p class="mb-4">
              Aucun sujet pour l'instant.
            </p>
          <% else %>
            <p class="alert mb-4">
              Veuillez choisir le fichier (PDF) du sujet d'examen, et cliquer sur "Déposer" pour transmettre le document
            </p>
          <% end %>
        <% else %>
          <p class="mb-4">
            <strong>Fichier PDF</strong>
          </p>
          <div class="text-center w-fit">
            <% if @sujet.sujet.representable? %>
              <div class="shadow w-fit p-4 mb-2">
                <%= image_tag(@sujet.sujet.representation(resize_to_limit: [300, 300])) %>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if @sujet.can_déposer? %>
          <%= render "partials/script_accept_pdf" %>
            <%= f.file_field :sujet, required: true, label: 'Fichier PDF', accept: 'application/pdf', class: 'file-input file-input-bordered file-input-sm file-input-success flex-1' %>
            <br>

            <div class="mt-8 mb-4">
              <h3 class="text-xl mt-4">Commentaire (optionnel)</h3>
              <i>Affiché sur la convocation étudiant</i>
            </div>

            <%= f.text_area :commentaires, rows: 3, class: 'textarea textarea-bordered w-full' %>

            <button type="submit" name="commit" value="Déposer le sujet" class="btn btn-success w-full sm:w-48 btn-lg text-white mt-6" data-disable-with="Déposer le sujet" data-turbo-confirm="ATTENTION ! Une fois déposé, vous ne pourrez plus modifier le sujet. Confirmez-vous le dépôt de votre sujet">
              <i class="far fa-arrow-alt-circle-down"></i>
              Déposer
            </button>
          <% end %>

      </div>
    </div>
  <% end %>
<% end %>